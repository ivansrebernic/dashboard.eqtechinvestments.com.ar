# Role System Implementation Guide\n\nThis document provides a complete guide for the role-based access control system implemented in this Next.js 15.3.4 application with Supabase.\n\n## Overview\n\nThe role system provides:\n- **Two roles**: `basic` and `admin`\n- **Route-based protection**: Automatic middleware-level access control\n- **Component-level guards**: Granular UI protection\n- **Admin interface**: User and role management\n- **Real-time updates**: Optimistic UI updates\n- **Error handling**: Comprehensive error boundaries\n\n## Setup Instructions\n\n### 1. Database Setup\n\nRun the database migration to create the role system:\n\n```sql\n-- Execute the SQL file in your Supabase SQL Editor\n-- File: scripts/setup-roles.sql\n```\n\nOr manually run the migration:\n\n```bash\nsupabase db push\n```\n\n### 2. Install Dependencies\n\nInstall the required packages:\n\n```bash\nnpm install @radix-ui/react-select\n```\n\n### 3. Environment Variables\n\nEnsure you have the required Supabase environment variables:\n\n```env\nNEXT_PUBLIC_SUPABASE_URL=your_supabase_url\nNEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key\n```\n\n### 4. Create First Admin User\n\nAfter running the setup script, create your first admin user by:\n\n1. Register a new account through your app\n2. In Supabase SQL Editor, run:\n   ```sql\n   UPDATE public.user_roles \n   SET role = 'admin' \n   WHERE user_id = (SELECT id FROM auth.users WHERE email = 'your-email@example.com');\n   ```\n\n## File Structure\n\n```\nsrc/\n├── lib/roles/\n│   ├── service.ts          # Role service (client & server)\n│   ├── permissions.ts      # Permission definitions\n│   ├── hooks.ts           # React hooks for roles\n│   └── actions.ts         # Server actions\n├── components/\n│   ├── auth/\n│   │   └── route-guard.tsx # Route protection components\n│   ├── roles/\n│   │   └── role-badge.tsx # Role display components\n│   ├── admin/\n│   │   └── user-management-table.tsx # User management UI\n│   ├── navigation/\n│   │   └── nav-menu.tsx   # Role-aware navigation\n│   └── errors/\n│       └── role-error-boundary.tsx # Error handling\n├── app/\n│   ├── admin/\n│   │   ├── page.tsx       # Admin dashboard\n│   │   └── users/page.tsx # User management\n│   ├── unauthorized/page.tsx # Access denied page\n│   └── api/admin/users/route.ts # API endpoints\n├── types/auth.ts          # TypeScript definitions\nmiddleware.ts              # Route protection middleware\n```\n\n## Usage Examples\n\n### 1. Route Protection with Middleware\n\nRoutes are automatically protected based on the configuration in `src/lib/roles/permissions.ts`:\n\n```typescript\n// Automatic protection - no additional code needed\n// /admin/* routes require 'admin' role\n// /dashboard requires 'basic' role\n```\n\n### 2. Component-Level Protection\n\n```tsx\nimport { AdminGuard, PermissionGuard } from '@/components/auth/route-guard'\n\n// Role-based guard\n<AdminGuard>\n  <AdminOnlyComponent />\n</AdminGuard>\n\n// Permission-based guard\n<PermissionGuard permission=\"canManageUsers\">\n  <UserManagementButton />\n</PermissionGuard>\n```\n\n### 3. Using Role Hooks\n\n```tsx\nimport { useUserRole, usePermissions } from '@/lib/roles/hooks'\n\nfunction MyComponent() {\n  const { role, loading, isAdmin } = useUserRole()\n  const { canAccessAdmin, canManageUsers } = usePermissions()\n  \n  if (loading) return <Loading />\n  \n  return (\n    <div>\n      <p>Your role: {role}</p>\n      {canAccessAdmin && <AdminPanel />}\n      {canManageUsers && <UserManager />}\n    </div>\n  )\n}\n```\n\n### 4. Server Actions\n\n```tsx\nimport { assignUserRole } from '@/lib/roles/actions'\n\nasync function handleRoleChange() {\n  const result = await assignUserRole(userId, 'admin')\n  if (result.success) {\n    // Handle success\n  } else {\n    // Handle error\n  }\n}\n```\n\n### 5. API Route Protection\n\n```typescript\n// Example protected API route\nexport async function GET(request: NextRequest) {\n  const supabase = createClient()\n  const { data: { user } } = await supabase.auth.getUser()\n  \n  if (!user) {\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n  }\n  \n  const isAdmin = await serverRoleService.isAdmin(user.id)\n  if (!isAdmin) {\n    return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 })\n  }\n  \n  // Admin-only logic here\n}\n```\n\n## Role Definitions\n\n### Basic Role\n- Access to dashboard\n- View cryptocurrency data\n- Standard user features\n\n### Admin Role\n- All basic role permissions\n- Access to admin panel\n- Manage users and roles\n- View all system data\n\n## Permission System\n\nPermissions are defined in `src/lib/roles/permissions.ts`:\n\n```typescript\nexport const ROLE_PERMISSIONS = {\n  admin: {\n    canAccessAdmin: true,\n    canManageUsers: true,\n    canAssignRoles: true,\n    canViewAllUsers: true,\n    canDeleteUsers: true,\n    canAccessDashboard: true,\n    canViewCrypto: true,\n  },\n  basic: {\n    canAccessAdmin: false,\n    canManageUsers: false,\n    canAssignRoles: false,\n    canViewAllUsers: false,\n    canDeleteUsers: false,\n    canAccessDashboard: true,\n    canViewCrypto: true,\n  }\n}\n```\n\n## Protected Routes\n\n### Admin Routes\n- `/admin` - Admin dashboard\n- `/admin/users` - User management\n- `/admin/roles` - Role management (future)\n- `/admin/settings` - System settings (future)\n\n### Basic Routes\n- `/dashboard` - User dashboard\n- `/profile` - User profile (future)\n\n### Public Routes\n- `/` - Home page\n- `/login` - Login page\n- `/signup` - Registration page\n- `/unauthorized` - Access denied page\n\n## Database Schema\n\n### user_roles Table\n\n```sql\nCREATE TABLE public.user_roles (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  role TEXT NOT NULL CHECK (role IN ('basic', 'admin')),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id),\n  UNIQUE(user_id)\n);\n```\n\n### Row Level Security (RLS)\n\n- Users can read their own role\n- Admins can read all roles\n- Only admins can modify roles\n\n## Error Handling\n\nThe system includes comprehensive error handling:\n\n1. **Middleware errors**: Redirect to `/unauthorized`\n2. **Component errors**: Error boundaries with user-friendly messages\n3. **API errors**: Proper HTTP status codes and error messages\n4. **Loading states**: Skeleton loading for all async operations\n\n## Troubleshooting\n\n### Common Issues\n\n1. **\"Insufficient permissions\" error**\n   - Check user role in database\n   - Verify RLS policies are set correctly\n   - Ensure user is authenticated\n\n2. **Middleware redirect loops**\n   - Check public routes configuration\n   - Verify user session is valid\n   - Check route patterns in middleware\n\n3. **Role not updating in UI**\n   - Check if role assignment was successful\n   - Verify revalidation is working\n   - Force refresh the page\n\n### Debug Commands\n\n```sql\n-- Check user roles\nSELECT u.email, ur.role, ur.created_at \nFROM auth.users u \nLEFT JOIN public.user_roles ur ON u.id = ur.user_id;\n\n-- Check role assignment for specific user\nSELECT * FROM public.user_roles WHERE user_id = 'user-uuid-here';\n\n-- Manually assign admin role\nUPDATE public.user_roles \nSET role = 'admin' \nWHERE user_id = 'user-uuid-here';\n```\n\n## Testing\n\n### Manual Testing Checklist\n\n- [ ] New user gets 'basic' role automatically\n- [ ] Basic user can access dashboard\n- [ ] Basic user cannot access admin routes\n- [ ] Admin user can access all routes\n- [ ] Admin user can change other users' roles\n- [ ] Role changes reflect immediately in UI\n- [ ] Unauthorized access shows proper error page\n- [ ] Navigation hides/shows items based on role\n\n## Extending the System\n\n### Adding New Roles\n\n1. Update the role check in database:\n   ```sql\n   ALTER TABLE public.user_roles \n   DROP CONSTRAINT user_roles_role_check;\n   \n   ALTER TABLE public.user_roles \n   ADD CONSTRAINT user_roles_role_check \n   CHECK (role IN ('basic', 'admin', 'moderator'));\n   ```\n\n2. Update TypeScript types:\n   ```typescript\n   export type UserRole = 'basic' | 'admin' | 'moderator'\n   ```\n\n3. Update permissions in `permissions.ts`\n4. Update role info and badges\n\n### Adding New Permissions\n\n1. Add to `ROLE_PERMISSIONS` object\n2. Update permission type\n3. Add to hooks and guards\n4. Update UI components\n\n## Security Considerations\n\n1. **Row Level Security**: All database access is protected by RLS policies\n2. **Server-side validation**: All role checks happen on the server\n3. **Middleware protection**: Routes are protected at the Next.js level\n4. **API endpoint protection**: All admin APIs verify permissions\n5. **Client-side hiding**: UI elements are hidden but never relied upon for security\n\n## Performance Notes\n\n1. **Role caching**: Roles are cached in React state to minimize database calls\n2. **Optimistic updates**: UI updates immediately while syncing with server\n3. **Efficient queries**: Database queries use indexes for fast lookups\n4. **Minimal re-renders**: React hooks are optimized to prevent unnecessary renders\n\nThis role system provides a solid foundation for access control and can be extended as your application grows.\n"